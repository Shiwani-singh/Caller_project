<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Manage Users</h1>
        <a href="/admin/users/new" class="btn btn-primary">
          <i class="fas fa-plus"></i> Add New User
        </a>
      </div>

      <% if (locals.success) { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <%= success %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <% } %>

      <% if (locals.error) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <%= error %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <% } %>

      <!-- Search and Filter Form -->
      <div class="card mb-4">
        <div class="card-body">
          <form method="GET" action="/admin/users" class="row g-3">
            <div class="col-md-4">
              <label for="search" class="form-label">Search</label>
              <input type="text" class="form-control" id="search" name="search" 
                     value="<%= locals.search || '' %>" placeholder="Name, email, or phone">
            </div>
            <div class="col-md-3">
              <label for="role_id" class="form-label">Role</label>
              <select class="form-select" id="role_id" name="role_id">
                <option value="">All Roles</option>
                <option value="1" <%= locals.role_id === '1' ? 'selected' : '' %>>Super Admin</option>
                <option value="2" <%= locals.role_id === '2' ? 'selected' : '' %>>Employee</option>
                <option value="3" <%= locals.role_id === '3' ? 'selected' : '' %>>Caller</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="sortBy" class="form-label">Sort By</label>
              <select class="form-select" id="sortBy" name="sortBy">
                <option value="created_at" <%= locals.sortBy === 'created_at' ? 'selected' : '' %>>Created Date</option>
                <option value="name" <%= locals.sortBy === 'name' ? 'selected' : '' %>>Name</option>
                <option value="email" <%= locals.sortBy === 'email' ? 'selected' : '' %>>Email</option>
                <option value="role_id" <%= locals.sortBy === 'role_id' ? 'selected' : '' %>>Role</option>
              </select>
            </div>
            <div class="col-md-2">
              <label for="sortOrder" class="form-label">Order</label>
              <select class="form-select" id="sortOrder" name="sortOrder">
                <option value="DESC" <%= locals.sortOrder === 'DESC' ? 'selected' : '' %>>Desc</option>
                <option value="ASC" <%= locals.sortOrder === 'ASC' ? 'selected' : '' %>>Asc</option>
              </select>
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-search"></i> Search
              </button>
              <a href="/admin/users" class="btn btn-secondary">
                <i class="fas fa-times"></i> Clear
              </a>
            </div>
          </form>
        </div>
      </div>

      <!-- Users Table -->
      <div class="card">
        <div class="card-body">
          <% if (users && users.length > 0) { %>
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Role</th>
                    <th>Created</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% users.forEach(user => { %>
                    <tr>
                      <td><%= user.id %></td>
                      <td><%= user.name %></td>
                      <td><%= user.email %></td>
                      <td><%= user.phone %></td>
                      <td>
                        <span class="badge bg-<%= user.role_name === 'super_admin' ? 'danger' : user.role_name === 'employee' ? 'primary' : 'secondary' %>">
                          <%= user.role_name.replace('_', ' ').toUpperCase() %>
                        </span>
                      </td>
                      <td><%= new Date(user.created_at).toLocaleDateString() %></td>
                      <td>
                        <div class="btn-group" role="group">
                          <a href="/admin/users/<%= user.id %>/edit" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-edit"></i>
                          </a>
                          <% if (user.id !== 1) { %>
                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                    onclick="confirmDelete(<%= user.id %>, '<%= user.name %>')">
                              <i class="fas fa-trash"></i>
                            </button>
                          <% } %>
                        </div>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            <% if (pagination && pagination.pages > 1) { %>
              <nav aria-label="Users pagination">
                <ul class="pagination justify-content-center">
                  <% if (pagination.page > 1) { %>
                    <li class="page-item">
                      <a class="page-link" href="/admin/users?page=<%= pagination.page - 1 %>">
                        Previous
                      </a>
                    </li>
                  <% } %>
                  
                  <% for (let i = 1; i <= pagination.pages; i++) { %>
                    <li class="page-item <%= i === pagination.page ? 'active' : '' %>">
                      <a class="page-link" href="/admin/users?page=<%= i %>">
                        <%= i %>
                      </a>
                    </li>
                  <% } %>
                  
                  <% if (pagination.page < pagination.pages) { %>
                    <li class="page-item">
                      <a class="page-link" href="/admin/users?page=<%= pagination.page + 1 %>&">
                        Next
                      </a>
                    </li>
                  <% } %>
                </ul>
              </nav>
            <% } %>
          <% } else { %>
            <div class="text-center py-5">
              <i class="fas fa-users fa-3x text-muted mb-3"></i>
              <h5 class="text-muted">No users found</h5>
              <p class="text-muted">Try adjusting your search criteria or add a new user.</p>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function confirmDelete(userId, userName) {
  if (confirm(`Are you sure you want to delete user "${userName}"? This action cannot be undone.`)) {
    window.location.href = `/admin/users/${userId}/delete`;
  }
}
</script>


